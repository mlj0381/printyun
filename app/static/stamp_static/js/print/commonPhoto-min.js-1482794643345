var docMax=5;var docTotal=0;var docDel=0;$(function(){$("#add_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){$("#uploadify").click()}})});$("#submit_btn").click(function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){saveTask()}})});if($("#uploadify").fileupload){$("#uploadify").fileupload({url:"../print/uploadImage.action",type:"post",dataType:"json",autoUpload:true,sequentialUploads:true,}).on("fileuploadadd",function(e,data){if(docTotal+data.originalFiles.length>docMax){alertFail("\u4e00\u6b21\u6700\u591a\u4e0a\u4f20"+docMax+"\u4e2a\u6587\u4ef6\uff01");return false}for(var i=0;i<data.originalFiles.length;i++){if(!isImageFile(data.originalFiles[i].name)){alertFail("\u9009\u62e9\u7684\u6587\u4ef6\u683c\u5f0f\u9519\u8bef(\u53ea\u80fd\u9009\u62e9jpg,jpeg,bmp)\uff01");return false}if(data.originalFiles[i].size>83886080){alertFail("\u6587\u4ef6["+data.originalFiles[i].name+"]\u5927\u5c0f\u8d85\u51fa\u7cfb\u7edf\u9650\u5236\u768480M\u5927\u5c0f\uff01");return false}}startWait();$.blueimp.fileupload.prototype.options.add.call(this,e,data)}).on("fileuploaddone",function(e,data){data=data.result.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){setDocumentResult(eval("("+data.rsData+")"));docTotal++;if(docTotal==docMax){$(".add_btn").hide()}}else{alertFail("\u4e0a\u4f20\u5931\u8d25\uff01")}}).on("fileuploadstop",function(e,data){closeWait()})}else{$("#add_btn").hide();$("#uploadifyDiv").show();try{$("#uploadify").uploadify({swf:"../static/js/uploadify/uploadify.swf",uploader:"../print/uploadImageWithLowIe.action",buttonText:"\u6dfb\u52a0",buttonClass:"uploadifyClass",fileObjName:"file",height:30,width:100,fileTypeDesc:"\u652f\u6301\u7684\u683c\u5f0f\uff1a",fileTypeExts:"*.jpg; *.jpeg; *.bmp; *.JPG; *.JPEG; *.BMP;",auto:true,multi:true,fileSizeLimit:"80MB",queueSizeLimit:docMax,onInit:function(){$("#uploadify-queue").hide()},onFallback:function(){var p='<p>\u60a8\u672a\u5b89\u88c5FLASH\u63a7\u4ef6\uff0c\u65e0\u6cd5\u4e0a\u4f20\uff01\u8bf7<a style="color:#00a1ea;text-decoration: underline;"  href="https://get.adobe.com/cn/flashplayer/" target="_blank">\u5b89\u88c5FLASH\u63a7\u4ef6</a>\u6216\u5347\u7ea7\u6d4f\u89c8\u5668\u540e\u518d\u8bd5\u3002</p>';$("#def_content_tr td").append(p);$("#uploadifyDiv").hide();return false},onSelect:function(){if(isEmptyValue($("#uId").text())){loginDiv();return false}validateIsOnline({confirmHandle:function(){startWait()}})},onUploadSuccess:function(file,data,response){setDocumentResult(eval("("+data+")"));docTotal++;$("#uploadify").uploadify("settings","queueSizeLimit",docMax-docTotal);if(docTotal>=docMax){$("#uploadifyDiv").hide();closeWait()}},onQueueComplete:function(){closeWait()},onUploadError:function(file,errorCode,errorMsg,errorString,swfuploadifyQueue){closeWait()}})}catch(e){closeWait()}}});function setDocumentResult(c){var a=docTotal;var j='<tr id="image'+a+'"><td>'+getCutStr(c.fileName)+'</td><td><span id="errMsg'+a+'" style="color:red">'+c.ErrMsg+"</span></td>";if(c.ErrCode=="0"){j+='<td><img id="showImage'+a+'" src=""/></td><td><p><label><input type="radio" id="_doccolor3'+a+'" name="doccolor'+a+'"onclick="setColorAndFormat(this)" value="2" checked="checked"/><span style="font-weight: normal;cursor: pointer;">\u7167\u7247</span></label></p><p><label><input type="radio" id="_doccolor2'+a+'" name="doccolor'+a+'"onclick="setColorAndFormat(this)" value="0"/><span style="font-weight: normal;cursor: pointer;">\u5f69\u8272</span></label></p><p><label><input type="radio" id="_doccolor1'+a+'" name="doccolor'+a+'"onclick="setColorAndFormat(this)" value="1"/><span style="font-weight: normal;cursor: pointer;">\u9ed1\u767d</span></label></p></td><td><input type="text" size="5" id="_docnum'+a+'" name="_docnum'+a+'"onKeyUp="numVerify(this)" onBlur="numberBlur(this)" value="1" style="width:40px;border:1px solid #e4e4e4;"/></td><td><span id="unit_price'+a+'"></span></td><td><a id="_crop'+a+'" href="javascript:void(0)" onclick="cropImage('+a+')">\u88c1\u526a</a>&nbsp;&nbsp;<a id="_del'+a+'" href="javascript:void(0)" onclick="delDoc('+a+')">\u5220\u9664</a><div id="hidVal'+a+'" style="display:none"></div></td></tr>';$("#tbodyContent").append(j);$("#def_content_tr").hide();var i="<input id='docsize"+a+"' type='hidden' value=''>";var k="<input id='add_direction"+a+"' type='hidden' value='0'>";var b="<input id='fileName"+a+"' type='hidden' value='"+c.fileName+"'>";var h="<input id='add_pdffilename"+a+"' type='hidden' value='"+c.fileRealName+"'>";var g="<input id='str_sourceImg"+a+"' type='hidden' value='"+c.str_sourceImg+"'>";var f="<input id='sourceImg_width"+a+"' type='hidden' value='"+c.sourceImg_width+"'>";var d="<input id='sourceImg_height"+a+"' type='hidden' value='"+c.sourceImg_height+"'>";$("#hidVal"+a).append(i+k+b+h+g+f+d);$("#showImage"+a).attr("src","data:;base64,"+c.str_img);var e=getWidthAndHeight(c.img_width,c.img_height,100,100);$("#showImage"+a).css("width",e[0]+"px");$("#showImage"+a).css("height",e[1]+"px");setBaseMoney(a)}else{j+='<td colspan="4"></td>';j+='<td><a id="_del'+a+'" href="javascript:void(0)" onclick="delDoc('+a+')">\u5220\u9664</a><div id="hidVal'+a+'" style="display:none"></div></td></tr>';$("#tbodyContent").append(j);$("#def_content_tr").hide()}}function cropImage(c){var e=$("#fileName"+c).val();var b=$("#str_sourceImg"+c).val();$("#div_body").html("");document.getElementById("form").reset();$("#str_img").val(b);ShowDiv("MyDiv","fade");$("#cutFileName").val(e);var d='<div class="clearfix" style="position:relative;"><div style="width:15%;float:left;visibility:hidden;">\u586b\u5145\u533a\u57df</div><div id="myCanvasDv" class="img_yulan" style="width:70%;float:left;"><img id="preview" name="preview" src="data:;base64,'+b+'" /></div><div style="width:15%;height:100%;float:left;"><div style="position:absolute;top:50%;margin-top:-38px;"><div style="width:100px;height:2em;line-height:2em;background:#FF6802;cursor: pointer;margin-bottom:20px;color:#ffffff" onclick="reversal(1.5)">\u6a2a\u5411\u526a\u88c1</div><div style="width:100px;height:2em;line-height:2em;background:#00acef;cursor: pointer;color:#ffffff" onclick="reversal(0.66667)">\u7eb5\u5411\u526a\u88c1</div></div></div></div><div align="center" style="margin-top:20px;"><div class="confirm_btn" onclick="confirmImage('+c+')">\u786e\u5b9a</div><div style="width:50px;height:40px;visibility:hidden;display:inline-block;">\u586b\u5145\u533a\u57df</div><div class="cancel_btn" onclick="closeWindow()">\u53d6\u6d88</div></div>';$("#div_body").html(d);var a=document.getElementById("preview");a.onload=function(){var f=$("#preview").width();var g=$("#preview").height();$("#imWidth").val(f);$("#imHeight").val(g);if(g>=f){$("#horOrPer").val(1)}else{$("#horOrPer").val(0)}var h=getWidthAndHeight(f,g,350,350);$("#resWidth").val(h[0]);$("#resHeight").val(h[1]);$(".step2").fadeIn(500);if(h[1]>=h[0]){reversal(0.66667)}else{reversal(1.5)}}}function confirmImage(inx){if(isEmptyValue($("#w").val())||parseFloat($("#w").val())<=0){alertFail("\u6ca1\u6709\u88c1\u526a\u56fe\u7247\uff01");return false}startWait();var formData=$("#form").serialize();$.ajax({type:"POST",url:"../print/uploadImageWithStr.action",cache:false,data:formData,dataType:"json",success:function(data){closeWait();if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){data=eval("("+data.rsData+")");$("#showImage"+inx).attr("src","data:;base64,"+data.str_img);var arrObj=getWidthAndHeight(data.img_width,data.img_height,100,100);$("#showImage"+inx).css("width",arrObj[0]+"px");$("#showImage"+inx).css("height",arrObj[1]+"px");$("#add_pdffilename"+inx).val(data.fileRealName);closeWindow()}else{alertFail("\u88c1\u526a\u56fe\u7247\u5931\u8d25\uff01");return false}}})}function closeWindow(){$("#div_body").html("");document.getElementById("form").reset();CloseDiv("MyDiv","fade")}function setBaseMoney(i){var a_color=$("input[name=doccolor"+i+"]:checked").val();var a_size=$("#docsize"+i).val();if(a_color=="2"){a_size="5R"}else{a_size="A4"}$("#docsize"+i).val(a_size);$.ajax({type:"post",async:false,url:"../print/getPrice.action",data:{size:a_size,color:a_color,format:"0"},success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){var rsData=eval("("+data.rsData+")");$("#unit_price"+i).html(parseFloat(rsData.price).toFixed(2))}}})}function setColorAndFormat(a){var b=parseInt(a.getAttribute("id").charAt(a.getAttribute("id").length-1));if(a.getAttribute("id").substring(0,a.getAttribute("id").length-2)=="_doccolor"){if(a.value==0){$("#docsize"+b).val("A4")}else{if(a.value==1){$("#docsize"+b).val("A4")}else{if(a.value==2){$("#docsize"+b).val("5R")}}}}setBaseMoney(b)}function numVerify(a){a.value=a.value.replace(/[^\d]/g,"");if(a.value==""||a.value=="0"){return}}function numberBlur(a){if(a.value==""||a.value=="0"){a.value="1"}}function delDoc(d){$("#image"+d).remove();var c=$("#tbodyContent").children().length;if(c==2){$("#def_content_tr").show()}for(var b=(d+1);b<docTotal;b++){var a=b-1;$("#image"+b).attr("id","image"+a);$("#errMsg"+b).attr("id","errMsg"+a);$("#showImage"+b).attr("id","showImage"+a);$("#_doccolor3"+b).attr("id","_doccolor3"+a);$('input[name="doccolor'+b+'"]').attr("name","doccolor"+a);$("#_doccolor2"+b).attr("id","_doccolor2"+a);$("#_doccolor1"+b).attr("id","_doccolor1"+a);$("#_docnum"+b).attr("id","_docnum"+a);$('input[name="_docnum'+b+'"]').attr("name","_docnum"+a);$("#unit_price"+b).attr("id","unit_price"+a);$("#_crop"+b).attr("onclick","cropImage("+a+")");$("#_crop"+b).attr("id","_crop"+a);$("#_del"+b).attr("onclick","delDoc("+a+")");$("#_del"+b).attr("id","_del"+a);$("#hidVal"+b).attr("id","hidVal"+a);$("#docsize"+b).attr("id","docsize"+a);$("#add_direction"+b).attr("id","add_direction"+a);$("#fileName"+b).attr("id","fileName"+a);$("#add_pdffilename"+b).attr("id","add_pdffilename"+a);$("#str_sourceImg"+b).attr("id","str_sourceImg"+a);$("#sourceImg_width"+b).attr("id","sourceImg_width"+a);$("#sourceImg_height"+b).attr("id","sourceImg_height"+a)}docTotal--;if(!isLower10){$(".add_btn").show()}else{$("#uploadifyDiv").show()}}function delAllDoc(){for(var a=0;a<docTotal;a++){$("#image"+a).remove()}docTotal=0;$("#def_content_tr").show();if(!isLower10){$(".add_btn").show()}else{$("#uploadifyDiv").show()}}function isImageFile(c){var a=["jpg","jpeg","bmp"];if(!isEmptyValue(c)){var d=c.substring(c.lastIndexOf(".")+1,c.length);if(!isEmptyValue(d)){for(var b=0;b<a.length;b++){if(d.toLowerCase()==a[b]){return true}}}}return false}function saveTask(){var warnFlag=false;if(docTotal<=0){alertWarning("\u8bf7\u9009\u62e9\u4e0a\u4f20\u7167\u7247\uff01");return false}var errTotal=0;for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){errTotal++}}if(errTotal==docTotal){alertWarning("\u6ca1\u6709\u6210\u529f\u4e0a\u4f20\u7684\u7167\u7247\uff0c\u8bf7\u4e0a\u4f20\u6210\u529f\u540e\u518d\u6b21\u63d0\u4ea4\uff01");return false}for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){continue}if($("input:radio[name=doccolor"+i+"]:checked").val()==undefined){alertWarning("\u8bf7\u9009\u62e9\u7c7b\u578b\uff01");return false}}startWait();var present="";var successNum=0;var arr=new Array();for(var i=0;i<docTotal;i++){if($("#errMsg"+i).html().indexOf("\u6210\u529f")==-1){continue}var a_color=$("input:radio[name=doccolor"+i+"]:checked").val();var a_format="0";var a_size=$("#docsize"+i).val();var allnums="";var alldirection="";var filePage="1";var pdfnames="";var uploadifyFileName="";allnums=$("#_docnum"+i).val();alldirection=$("#add_direction"+i).val();pdfnames=$("#add_pdffilename"+i).val();uploadifyFileName=$("#fileName"+i).val();$.ajax({type:"post",async:false,url:"../print/createPrintTask.action",dataType:"json",data:{fileName:uploadifyFileName,fileRealName:pdfnames,filePage:filePage,color:a_color,format:a_format,size:a_size,number:allnums},success:function(data){if(data.toString().indexOf("window.top.location.href")>0){alertWarningCallBackDiv();return false}else{data=data.resultInfo;if(data.rsType==TYPE_RESULT.SUCCESS){arr.push(i);successNum++}else{if(data.rsType==TYPE_RESULT.WARN){warnFlag=true;var rsData=eval("("+data.rsData+")");closeWait();alertFail(rsData.ErrMsg);return false}}}}})}if(!warnFlag){if(successNum==docTotal-errTotal){closeWait();delAllDoc();alertSuccess("\u6253\u5370\u4efb\u52a1\u63d0\u4ea4\u6210\u529f,\u8bf7\u5230\u4e91\u6253\u5370\u7ec8\u7aef\u673a\u53d6\u4ef6!")}else{var len=arr.length;for(var j=0;j<len;j++){delDoc(j)}closeWait();alertFail("\u521b\u5efa\u6253\u5370\u4efb\u52a1\u5931\u8d25\uff01")}}};
